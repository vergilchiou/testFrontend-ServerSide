<!-- ä¸»è¦å…§å®¹ -->
<div class=" mt-5">
  <h4 class="fw-bold m-4">æŠ˜æ‰£ç¢¼ç®¡ç†</h4>
  <div class="card px-2">
    <div
      class="card-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3 bg-transparent">

      <div class="d-flex gap-2 w-100 w-md-auto mx-2">
        <div class="input-group flex-grow-1">
          <span class="input-group-text border-0 bg-transparent"><i class="bi bi-search"></i></span>
          <input type="text" class="form-control" placeholder="æœå°‹æŠ˜æ‰£ç¢¼..." aria-label="æœå°‹æŠ˜æ‰£ç¢¼" />
        </div>
        <button class="btn btn-dark">
          <span class="text-nowrap">+ æ·»åŠ æŠ˜æ‰£ç¢¼</span>
        </button>
      </div>
    </div>


    <!-- ç¯©é¸å€ -->
    <div class="d-flex flex-wrap gap-2 mb-4 mx-2">
      <!-- ç‹€æ…‹ -->
      <div class="dropdown">
        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="filterStatus"
          data-bs-toggle="dropdown" aria-expanded="false">
          æ‰€æœ‰ç‹€æ…‹
        </button>
        <ul class="dropdown-menu" aria-labelledby="filterStatus">
          <li><a class="dropdown-item" href="#">å•Ÿç”¨</a></li>
          <li><a class="dropdown-item" href="#">åœç”¨</a></li>
        </ul>
      </div>
      <!-- åˆ°æœŸæ—¥ æ’åº -->
      <div class="dropdown">
        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="sortExpiry"
          data-bs-toggle="dropdown" aria-expanded="false">
          åˆ°æœŸæ—¥ï¼ˆæœ€æ™šå„ªå…ˆï¼‰
        </button>
        <ul class="dropdown-menu" aria-labelledby="sortExpiry">
          <li><a class="dropdown-item" href="#">æœ€æ—©å„ªå…ˆ</a></li>
          <li><a class="dropdown-item" href="#">æœ€æ™šå„ªå…ˆ</a></li>
        </ul>
      </div>
    </div>

    <!-- è³‡æ–™è¡¨ -->
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle text-center">
          <thead class="table-light">
            <tr>
              <th scope="col"><input type="checkbox"></th>
              <th scope="col">ID</th>
              <th scope="col">æŠ˜æ‰£ç¢¼</th>
              <th scope="col">æŠ˜æ‰£</th>
              <th scope="col">é–‹å§‹æ—¥æœŸ</th>
              <th scope="col">çµæŸæ—¥æœŸ</th>
              <th scope="col">ç‹€æ…‹</th>
              <th scope="col">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="discountCodeTbody">
            <!-- JS å‹•æ…‹ç”Ÿæˆ -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- åˆ†é  -->
<nav class="mt-2" aria-label="Page navigation example">
  <ul class="pagination justify-content-center pagination-white">
    <li class="page-item">
      <a class="page-link" href="#" aria-label="Previous">
        <span aria-hidden="true">&laquo;</span>
      </a>
    </li>
    <li class="page-item"><a class="page-link" href="#">1</a></li>
    <li class="page-item"><a class="page-link" href="#">2</a></li>
    <li class="page-item"><a class="page-link" href="#">3</a></li>
    <li class="page-item">
      <a class="page-link" href="#" aria-label="Next">
        <span aria-hidden="true">&raquo;</span>
      </a>
    </li>
  </ul>
</nav>


<!-- JavaScript Bundle with Popper -->
<!-- <script src="./javascripts/discountCodeSwitchs.js"></script> -->

<script>
  function formatDiscount(type, value) {
    return type === "percentage" ? `${value * 100}%` : `$${value}`;
  }

  function formatDate(isoStr) {
    const date = new Date(isoStr);
    return date.toISOString().split("T")[0];
  }

  function renderDiscountTable(data) {
    const tbody = document.getElementById("discountCodeTbody");
    tbody.innerHTML = "";

    data.forEach((item) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td><input type="checkbox"></td>
        <td>${item.id}</td>
        <td>${item.code}</td>
        <td>${formatDiscount(item.type, item.value)}</td>
        <td>${formatDate(item.valid_from)}</td>
        <td>${formatDate(item.valid_until)}</td>
        <td>
          <div class="form-check form-switch d-inline-block">
            <input class="form-check-input" type="checkbox" id="toggle${item.id}" ${item.is_active ? "checked" : ""}>
            <label class="form-check-label" for="toggle${item.id}">${item.is_active ? "å•Ÿç”¨" : "åœç”¨"}</label>
          </div>
        </td>
        <td>
          <div class="dropdown">
            <button class="btn btn-link text-dark p-0" type="button" id="actionDropdown${item.id}" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-three-dots fs-6"></i>
            </button>
            <ul class="dropdown-menu" aria-labelledby="actionDropdown${item.id}">
              <li><a class="dropdown-item" href="/discountEdit?id=${item.id}">ç·¨è¼¯</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-danger" href="#" onclick="handleDelete(${item.id})">åˆªé™¤</a></li>
            </ul>
          </div>
        </td>
      `;
      tbody.appendChild(row);
    });

    bindStatusToggles();
  }

  function bindStatusToggles() {
    document.querySelectorAll('.form-check.form-switch input[type="checkbox"]').forEach((checkbox) => {
      const label = document.querySelector(`label[for="${checkbox.id}"]`);
      const updateLabel = () => {
        label.textContent = checkbox.checked ? 'å•Ÿç”¨' : 'åœç”¨';
      };
      updateLabel();
      checkbox.addEventListener("change", updateLabel);
    });
  }

  async function fetchDiscountCodes() {
    try {
      const token = localStorage.getItem("adminToken");
      const response = await fetch(`${window.API_BASE_URL}/admin/discount-codes`, {
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json"
        }
      });

      const result = await response.json();

      if (result.status && Array.isArray(result.data)) {
        renderDiscountTable(result.data);
      } else {
        alert("è¼‰å…¥æŠ˜æ‰£ç¢¼æ¸…å–®å¤±æ•—ï¼š" + result.message);
      }
    } catch (error) {
      console.error("è¼‰å…¥æŠ˜æ‰£ç¢¼ç™¼ç”ŸéŒ¯èª¤", error);
      alert("ç™¼ç”ŸéŒ¯èª¤ï¼Œç„¡æ³•å–å¾—æŠ˜æ‰£ç¢¼è³‡æ–™");
    }
  }

  document.addEventListener("DOMContentLoaded", fetchDiscountCodes);

  function handleDelete(id) {
    alert(`ï¼ˆç¤ºæ„ï¼‰ä½ æŒ‰äº†åˆªé™¤æŠ˜æ‰£ç¢¼ ID ${id}`);
    // ğŸš§ TODOï¼šä¸²æ¥ DELETE API å®Œæˆåˆªé™¤å¾Œé‡æ–° fetchDiscountCodes()
  }
</script>