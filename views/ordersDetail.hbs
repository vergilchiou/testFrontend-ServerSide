<!-- è¨‚å–®è³‡è¨Šå€å¡Š -->
<ul class="nav nav-tabs mt-4" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabOrderInfo" type="button"
      role="tab">è¨‚å–®è³‡è¨Š</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabShipping" type="button" role="tab">ç‰©æµè³‡è¨Š</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabPayment" type="button" role="tab">ä»˜æ¬¾è³‡è¨Š</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabProduct" type="button" role="tab">å•†å“è©³æƒ…</button>
  </li>
</ul>

<div class="tab-content py-3">
  <div class="tab-pane fade show active m-3" id="tabOrderInfo" role="tabpanel">
    <p><strong>è¨‚å–®ç·¨è™Ÿï¼š</strong><span id="infoOrderNumber"></span></p>
    <p><strong>è¨‚å–®ç‹€æ…‹ï¼š</strong><span id="infoOrderStatus"></span></p>
    <p><strong>å»ºç«‹æ™‚é–“ï¼š</strong><span id="infoCreatedAt"></span></p>
    <p><strong>ç”¨æˆ¶å§“åï¼š</strong><span id="infoUserName"></span></p>
    <p><strong>ç”¨æˆ¶é›»è©±ï¼š</strong><span id="infoUserPhone"></span></p>
    <p><strong>ç”¨æˆ¶ Emailï¼š</strong><span id="infoUserEmail"></span></p>
    <p><strong>è¨‚å–®é‡‘é¡ï¼š</strong><span id="infoTotalAmount"></span></p>
    <p><strong>é‹è²»ï¼š</strong><span id="infoShippingFee"></span></p>
    <p><strong>æŠ˜æ‰£é‡‘é¡ï¼š</strong><span id="infoDiscountAmount"></span></p>
    <p><strong>æœ€çµ‚é‡‘é¡ï¼š</strong><span id="infoFinalAmount"></span></p>
    <p><strong>è¨‚å–®å‚™è¨»ï¼š</strong><span id="infoNote"></span></p>
    <p><strong>ç‹€æ…‹å‚™è¨»ï¼š</strong><span id="infoStatusNote"></span></p>
  </div>
  <div class="tab-pane fade m-3" id="tabShipping" role="tabpanel">
    <p><strong>é…é€æ–¹å¼ï¼š</strong><span id="infoShippingMethod"></span></p>
    <p><strong>é‹é€ç‹€æ…‹ï¼š</strong><span id="infoShippingStatus"></span></p>
    <p><strong>æ”¶ä»¶äººå§“åï¼š</strong><span id="infoRecipientName"></span></p>
    <p><strong>æ”¶ä»¶äººé›»è©±ï¼š</strong><span id="infoRecipientPhone"></span></p>
    <p><strong>æ”¶ä»¶äººåœ°å€ï¼š</strong><span id="infoShippingAddress"></span></p>
    <p><strong>å–æ¶ˆæ™‚é–“ï¼š</strong><span id="infoCancelledAt"></span></p>
    <p><strong>å®Œæˆæ™‚é–“ï¼š</strong><span id="infoCompletedAt"></span></p>
    <p><strong>é€€è²¨æ™‚é–“ï¼š</strong><span id="infoReturnAt"></span></p>
  </div>
  <div class="tab-pane fade m-3" id="tabPayment" role="tabpanel">
    <p><strong>ä»˜æ¬¾æ–¹å¼ï¼š</strong><span id="infoPaymentMethod"></span></p>
    <p><strong>ä»˜æ¬¾ç‹€æ…‹ï¼š</strong><span id="infoPaymentStatus"></span></p>
    <p><strong>äº¤æ˜“ç·¨è™Ÿï¼š</strong><span id="infoTransactionNumber"></span></p>
    <p><strong>ä»˜æ¬¾æ™‚é–“ï¼š</strong><span id="infoPaidAt"></span></p>
  </div>
  <div class="tab-pane fade" id="tabProduct" role="tabpanel">
    <table class="table">
      <thead>
        <tr>
          <th>å•†å“åç¨±</th>
          <th>æ•¸é‡</th>
          <th>å–®åƒ¹</th>
          <th>å°è¨ˆ</th>
        </tr>
      </thead>
      <tbody id="orderItemsTable"></tbody>
      <tfoot>
        <tr>
          <td colspan="3" class="text-end">å•†å“å°è¨ˆï¼š</td>
          <td id="orderItemTotal"></td>
        </tr>
        <tr>
          <td colspan="3" class="text-end">é‹è²»ï¼š</td>
          <td id="orderShippingFee"></td>
        </tr>
        <tr>
          <td colspan="3" class="text-end">æŠ˜æ‰£é‡‘é¡ï¼š</td>
          <td id="orderDiscountAmount"></td>
        </tr>
        <tr>
          <td colspan="3" class="text-end fw-bold">è¨‚å–®ç¸½è¨ˆï¼š</td>
          <td id="orderSummaryTotal" class="fw-bold"></td>
        </tr>
      </tfoot>
    </table>
  </div>
</div>

<!-- å‡ºè²¨ã€é€€è²¨æ“ä½œæŒ‰éˆ• -->
<div class="d-flex flex-wrap flex-row-reverse gap-2 m-3 mt-4" id="actionButtonGroup">
  <button class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#modalViewDetails">æŸ¥çœ‹è©³ç´°</button>
  <button class="btn btn-outline-dark" id="printOrder">åˆ—å°è¨‚å–®</button>
  <a class="btn btn-dark" id="editOrderLink">ç·¨è¼¯è¨‚å–®</a>
  <button class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#modalShip" id="btnShip">ç¢ºèªå‡ºè²¨</button>
  <button class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#modalApproveReturn"
    id="btnApproveReturn">ç¢ºèªé€€è²¨</button>
  <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#modalRejectReturn"
    id="btnRejectReturn">æ‹’çµ•é€€è²¨</button>
  <button class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#modalApplyRefund"
    id="btnApplyRefund">ç”³è«‹é€€æ¬¾</button>
</div>

<!-- å‡ºè²¨ã€é€€è²¨æ“ä½œæŒ‰éˆ•çš„ Modal -->
<!-- ç¢ºèªå‡ºè²¨ Modal -->
<div class="modal fade" id="modalShip" tabindex="-1" aria-labelledby="modalShipLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ç¢ºèªå‡ºè²¨</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>è¨‚å–®ç·¨è™Ÿï¼š</strong><span id="modalOrderNumber"></span></p>
        <div class="mb-3">
          <label for="modalStatusNote" class="form-label">ç‹€æ…‹å‚™è¨»</label>
          <textarea class="form-control" id="modalStatusNote" rows="3"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button type="button" class="btn btn-dark" id="confirmShipBtn">ç¢ºèªå‡ºè²¨</button>
      </div>
    </div>
  </div>
</div>

<!-- åŒæ„é€€è²¨ Modal -->
<div class="modal fade" id="modalApproveReturn" tabindex="-1" aria-labelledby="modalApproveReturnLabel"
  aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">åŒæ„é€€è²¨</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>è¨‚å–®ç·¨è™Ÿï¼š</strong><span id="modalApproveOrderNumber"></span></p>
        <p>æ‚¨ç¢ºå®šè¦åŒæ„é€€è²¨å—ï¼Ÿ</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button type="button" class="btn btn-dark" id="confirmApproveReturnBtn">åŒæ„</button>
      </div>
    </div>
  </div>
</div>

<!-- æ‹’çµ•é€€è²¨ Modal -->
<div class="modal fade" id="modalRejectReturn" tabindex="-1" aria-labelledby="modalRejectReturnLabel"
  aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-danger">æ‹’çµ•é€€è²¨</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>è¨‚å–®ç·¨è™Ÿï¼š</strong><span id="modalRejectOrderNumber"></span></p>
        <div class="mb-3">
          <label for="modalRejectReason" class="form-label text-danger">æ‹’çµ•åŸå›  *</label>
          <textarea class="form-control" id="modalRejectReason" rows="3" required></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button type="button" class="btn btn-danger" id="confirmRejectReturnBtn">æ‹’çµ•</button>
      </div>
    </div>
  </div>
</div>


<script>
  function getLabel(key) {
    const map = {
      pending: "å¾…å‡ºè²¨",
      shipped: "å·²å‡ºè²¨",
      completed: "å·²å®Œæˆ",
      cancelled: "å·²å–æ¶ˆ",
      returnRequested: "å·²ç”³è«‹é€€è²¨",
      returnAccepted: "å·²åŒæ„é€€è²¨",
      returnRejected: "å·²æ‹’çµ•é€€è²¨",
      paid: "å·²ä»˜æ¬¾",
      refunded: "å·²é€€æ¬¾",
      authorizationVoided: "å·²å–æ¶ˆæˆæ¬Š",
      notReceived: "å°šæœªæ”¶è²¨",
      processing: "è™•ç†ä¸­",
      inTransit: "é‹é€ä¸­",
      delivered: "å·²åˆ°è²¨",
      returned: "å·²é€€è²¨",
    };
    return map[key] || key;
  }

  function getBadgeClass(key) {
    const colormap = {
      pending: "bg-warning text-dark",
      shipped: "bg-primary text-white",
      completed: "bg-success text-white",
      cancelled: "bg-secondary text-white",
      returnRequested: "bg-warning text-dark",
      returnAccepted: "bg-primary text-white",
      returnRejected: "bg-danger text-white",
      paid: "bg-success text-white",
      refunded: "bg-secondary text-white",
      authorizationVoided: "bg-secondary text-white",
      notReceived: "bg-secondary text-white",
      processing: "bg-info text-dark",
      inTransit: "bg-primary text-white",
      delivered: "bg-success text-white",
      returned: "bg-danger text-white",
    };
    return colormap[key] || "bg-dark";
  }

  document.addEventListener("DOMContentLoaded", async () => {
    const token = localStorage.getItem("adminToken");
    const urlParams = new URLSearchParams(window.location.search);
    const orderNumber = urlParams.get("orderNumber");
    if (!orderNumber || !token) return;

    const res = await fetch(`${window.API_BASE_URL}/admin/orders/${orderNumber}`, {
      headers: {
        Authorization: `Bearer ${token}`,
      },
    });
    const result = await res.json();
    if (!result.status) return;
    const data = result.data;

    // ä¿®æ”¹ç·¨è¼¯æŒ‰éˆ•é€£çµ
    document.getElementById("editOrderLink").href = `/ordersEdit?orderNumber=${orderNumber}`;


    // è¨‚å–®è³‡è¨Šæ¸²æŸ“
    document.getElementById("infoOrderNumber").textContent = data.orderNumber;
    // document.getElementById("infoOrderStatus").textContent = data.orderStatus;
    const orderStatusEl = document.getElementById("infoOrderStatus");
    orderStatusEl.innerHTML = `<span class="badge ${getBadgeClass(data.orderStatus)}">${getLabel(data.orderStatus)}</span>`;
    document.getElementById("infoCreatedAt").textContent = new Date(data.createdAt).toLocaleString();
    document.getElementById("infoUserName").textContent = data.user?.name || "â€”";
    document.getElementById("infoUserPhone").textContent = data.user?.phone || "â€”";
    document.getElementById("infoUserEmail").textContent = data.user?.email || "â€”";
    document.getElementById("infoTotalAmount").textContent = `$${data.totalAmount}`;
    document.getElementById("infoShippingFee").textContent = `$${data.shippingFee}`;
    document.getElementById("infoDiscountAmount").textContent = `$${data.discountAmount}`;
    document.getElementById("infoFinalAmount").textContent = `$${data.finalAmount}`;
    document.getElementById("infoNote").textContent = data.note || "â€”";
    document.getElementById("infoStatusNote").textContent = data.statusNote || "â€”";


    // ç‰©æµè³‡è¨Šæ¸²æŸ“
    document.getElementById("infoShippingMethod").textContent = data.shippingInfo?.shippingMethod || "â€”";
    // document.getElementById("infoShippingStatus").textContent = data.shippingStatus;
    const shippingStatusEl = document.getElementById("infoShippingStatus");
    shippingStatusEl.innerHTML = `<span class="badge ${getBadgeClass(data.shippingStatus)}">${getLabel(data.shippingStatus)}</span>`;

    document.getElementById("infoRecipientName").textContent = data.shippingInfo?.recipientName || "â€”";
    document.getElementById("infoRecipientPhone").textContent = data.shippingInfo?.recipientPhone || "â€”";
    document.getElementById("infoShippingAddress").textContent = data.shippingInfo?.shippingAddress || "â€”";
    document.getElementById("infoCancelledAt").textContent = data.cancelledAt ? new Date(data.cancelledAt).toLocaleString() : "â€”";
    document.getElementById("infoCompletedAt").textContent = data.completedAt ? new Date(data.completedAt).toLocaleString() : "â€”";
    document.getElementById("infoReturnAt").textContent = data.returnAt ? new Date(data.returnAt).toLocaleString() : "â€”";


    // ä»˜æ¬¾è³‡è¨Šæ¸²æŸ“
    document.getElementById("infoPaymentMethod").textContent = data.paymentMethod;
    // document.getElementById("infoPaymentStatus").textContent = data.paymentStatus;
    const paymentStatusEl = document.getElementById("infoPaymentStatus");
    paymentStatusEl.innerHTML = `<span class="badge ${getBadgeClass(data.paymentStatus)}">${getLabel(data.paymentStatus)}</span>`;
    document.getElementById("infoTransactionNumber").textContent = data.transactionNumber || "â€”";
    document.getElementById("infoPaidAt").textContent = data.paidAt ? new Date(data.paidAt).toLocaleString() : "â€”";


    // å•†å“è©³æƒ…æ¸²æŸ“
    const tbody = document.getElementById("orderItemsTable");
    let itemTotal = 0;
    data.items.forEach(item => {
      // console.log("ğŸ…¸ Item:", item);
      itemTotal += item.subtotal;
      const tr = document.createElement("tr");
      tr.innerHTML = `
    <td class="text-start">${item.productTitle}</td>
    <td>${item.quantity}</td>
    <td>$${item.price}</td>
    <td>$${item.subtotal}</td>
  `;
      tbody.appendChild(tr);
    });

    const shippingFee = data.shippingFee || 0;
    const discountAmount = data.discountAmount || 0;
    const grandTotal = itemTotal + shippingFee - discountAmount;

    // æ¸²æŸ“å°è¨ˆã€é‹è²»èˆ‡ç¸½è¨ˆ
    document.getElementById("orderItemTotal").textContent = `$${itemTotal}`;
    document.getElementById("orderShippingFee").textContent = `$${shippingFee}`;
    document.getElementById("orderDiscountAmount").textContent = `$${discountAmount}`;
    document.getElementById("orderSummaryTotal").textContent = `$${grandTotal}`;

    // æ§åˆ¶æŒ‰éˆ•å•Ÿç”¨/ç¦ç”¨
    const btnShip = document.getElementById("btnShip");
    const btnApproveReturn = document.getElementById("btnApproveReturn");
    const btnRejectReturn = document.getElementById("btnRejectReturn");
    const btnApplyRefund = document.getElementById("btnApplyRefund");

    btnShip.disabled = !(data.orderStatus === "pending" && data.paymentStatus === "paid" && data.shippingStatus === "notReceived");
    btnApproveReturn.disabled = !(data.orderStatus === "returnRequested" && data.paymentStatus === "paid" && data.shippingStatus === "delivered");
    btnRejectReturn.disabled = btnApproveReturn.disabled;
    btnApplyRefund.disabled = !(data.orderStatus === "returnAccepted");

    async function updateOrderStatus(type, extraBody = {}) {
      try {
        const body = {
          orderNumber: data.orderNumber,
          // statusNote: data.statusNote || "",
          statusNote: document.getElementById("modalStatusNote")?.value || "",
          ...extraBody
        };
        const res = await fetch(`${window.API_BASE_URL}/admin/orders/action?type=${type}`, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify(body)
        });
        const result = await res.json();
        if (result.status) {
          alert(result.message);
          location.reload();
        } else {
          alert("âŒ æ“ä½œå¤±æ•—ï¼š" + result.message);
        }
      } catch (error) {
        alert("âŒ ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
        console.error("æ›´æ–°è¨‚å–®ç‹€æ…‹éŒ¯èª¤ï¼š", error);
      }
    }

    // é å…ˆå¡«å…¥ modal çš„è³‡æ–™
    btnShip?.addEventListener("click", () => {
      document.getElementById("modalOrderNumber").textContent = data.orderNumber;
      document.getElementById("modalStatusNote").value = data.statusNote || "";
    });

    btnApproveReturn?.addEventListener("click", () => {
      document.getElementById("modalApproveOrderNumber").textContent = data.orderNumber;
    });

    btnRejectReturn?.addEventListener("click", () => {
      document.getElementById("modalRejectOrderNumber").textContent = data.orderNumber;
      document.getElementById("modalRejectReason").value = "";
    });

    // æ‰è§¸ç™¼ Modal è£¡ã€Œç¢ºèªå‡ºè²¨ã€æŒ‰éˆ• API
    document.getElementById("confirmShipBtn")?.addEventListener("click", () => {
      updateOrderStatus("ship");
    });

    document.getElementById("confirmApproveReturnBtn")?.addEventListener("click", () => {
      updateOrderStatus("approveReturn");
    });

    document.getElementById("confirmRejectReturnBtn")?.addEventListener("click", () => {
      const reason = document.getElementById("modalRejectReason").value;
      if (!reason) return alert("è«‹è¼¸å…¥æ‹’çµ•åŸå› ");
      updateOrderStatus("rejectReturn", { rejectReason: reason });
    });
  });
</script>