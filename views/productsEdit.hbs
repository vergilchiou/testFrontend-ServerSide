<div class="modal-dialog modal-xl">
  <div class="modal-content">
    <!-- æ¨™é¡Œåˆ— -->
    <div class="modal-header">
      <h5 class="modal-title">ç·¨è¼¯å•†å“</h5>
      <a href="/products" class="btn-close"></a>
    </div>

    <!-- ä¸»é«” -->
    <div class="modal-body">
      <!-- åˆ†é æ¨™ç±¤ -->
      <ul class="nav nav-tabs" id="productTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" type="button"
            role="tab">åŸºæœ¬è³‡æ–™</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="images-tab" data-bs-toggle="tab" data-bs-target="#images" type="button"
            role="tab">å•†å“åœ–ç‰‡</button>
        </li>
      </ul>

      <div class="tab-content pt-3" id="productTabContent">
        <!-- åŸºæœ¬è³‡æ–™ åˆ†é  -->
        <div class="tab-pane fade show active" id="basic" role="tabpanel" aria-labelledby="basic-tab">
          <form id="addProductForm" data-product-id="{{productId}}">

            <div class="row g-3">
              <div class="col-md-6">
                <label for="title" class="form-label">æ›¸ç±æ¨™é¡Œ *</label>
                <input type="text" class="form-control" id="title" name="title" required>
              </div>
              <div class="col-md-6">
                <label for="author" class="form-label">ä½œè€…</label>
                <input type="text" class="form-control" id="author" name="author">
              </div>
              <div class="col-md-6">
                <label for="illustrator" class="form-label">ç¹ªè€…</label>
                <input type="text" class="form-control" id="illustrator" name="illustrator">
              </div>
              <div class="col-md-6">
                <label for="publisher" class="form-label">å‡ºç‰ˆç¤¾</label>
                <input type="text" class="form-control" id="publisher" name="publisher">
              </div>
              <div class="col-md-6">
                <label for="isbn" class="form-label">ISBNè™Ÿç¢¼</label>
                <input type="text" class="form-control" id="isbn" name="isbn">
              </div>
              <div class="col-12">
                <label for="description" class="form-label">å•†å“æè¿°</label>
                <textarea class="form-control" id="description" name="description" rows="3"></textarea>
              </div>
              <div class="col-md-6">
                <label for="status" class="form-label">å•†å“ç‹€æ…‹</label>
                <select class="form-select" id="status" name="status" required>
                  <option value="true">å·²ä¸Šæ¶</option>
                  <option value="false">å·²ä¸‹æ¶</option>
                </select>
              </div>
              <!-- Summernote -->
              <div class="col-12">
                <label for="contentIntro" class="form-label">æ›¸ç±å…§å®¹ä»‹ç´¹</label>
                <textarea id="contentIntro" name="contentIntro"></textarea>
              </div>
              <hr class="my-4">
              <div class="col-md-4">
                <label for="price" class="form-label">å”®åƒ¹ *</label>
                <input type="number" step="0.01" class="form-control" id="price" name="price" required>
              </div>
              <div class="col-md-4">
                <label for="discountPrice" class="form-label">æŠ˜æ‰£å¾Œåƒ¹æ ¼</label>
                <input type="number" step="0.01" class="form-control" id="discountPrice" name="discountPrice">
              </div>
              <div class="col-md-4">
                <label for="stock" class="form-label">åº«å­˜æ•¸é‡ *</label>
                <input type="number" class="form-control" id="stock" name="stock" required>
              </div>
              <div class="col-md-3">
                <label for="pageCount" class="form-label">é æ•¸</label>
                <input type="number" class="form-control" id="pageCount" name="pageCount">
              </div>
              <div class="col-md-3">
                <label for="publishDate" class="form-label">å‡ºç‰ˆæ—¥æœŸ</label>
                <input type="date" class="form-control" id="publishDate" name="publishDate">
              </div>
              <div class="col-md-3">
                <label for="ageRange" class="form-label">å¹´é½¡å±¤åˆ†é¡ *</label>
                <select class="form-select" id="ageRange" name="ageRange" required>
                  <option value="">è«‹é¸æ“‡å¹´é½¡å±¤</option>
                </select>

              </div>
              <div class="col-md-3">
                <label for="theme" class="form-label">å•†å“ä¸»é¡Œ *</label>
                <select class="form-select" id="theme" name="theme" required>
                  <option value="">è«‹é¸æ“‡ä¸»é¡Œ</option>
                </select>
              </div>
              <div class="col-12">
                <label class="form-label">å•†å“æ¨™ç±¤</label>
                <div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="tag-1" name="isNewArrival">
                    <label class="form-check-label me-3" for="tag-1">æ–°å“ä¸Šå¸‚</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="tag-2" name="isBestseller">
                    <label class="form-check-label me-3" for="tag-2">ç†±éŠ·å“é …</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="tag-3" name="isDiscount">
                    <label class="form-check-label me-3" for="tag-3">ç‰¹åƒ¹ä¸­</label>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>

        <!-- å•†å“åœ–ç‰‡ åˆ†é  -->
        <div class="tab-pane fade" id="images" role="tabpanel" aria-labelledby="images-tab">
          <form id="uploadImagesForm" enctype="multipart/form-data">
            <div id="imageList">
              {{#each [0,1,2,3,4,5]}}
              <div class="card mb-3 image-item" data-index="{{this}}">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <strong>åœ–ç‰‡ {{addOne this}}</strong>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <label class="form-label">ä¸Šå‚³åœ–ç‰‡</label>
                    <input type="file" name="productImages" class="form-control">
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="mainImage" value="{{this}}"
                      id="mainImage-{{this}}" {{#if @first}}checked{{/if}}>
                    <label class="form-check-label" for="mainImage-{{this}}">
                      è¨­ç‚ºä¸»è¦åœ–ç‰‡
                    </label>
                  </div>
                </div>
              </div>
              {{/each}}
            </div>
            <button type="submit" class="btn btn-success w-100">ğŸ“¤ ä¸Šå‚³åœ–ç‰‡</button>
          </form>
        </div>



      </div>
    </div>

    <!-- æŒ‰éˆ•åˆ— -->
    <div class="modal-footer my-2">
      <a type="button" href="/products" class="btn btn-secondary">å–æ¶ˆ</a>
      <button type="submit" form="addProductForm" class="btn btn-primary ms-2">ç¢ºå®šæ–°å¢</button>
    </div>
  </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>

<!-- summernote -->
<script>
  $(document).ready(function () {
    $('#contentIntro').summernote({
      height: 300,
      toolbar: [
        // æ¨£å¼
        ['style', ['style']],
        // æ–‡å­—
        ['font', ['bold', 'italic', 'underline', 'strikethrough', 'clear']],
        // å­—å‹
        ['fontname', ['fontname']],
        ['fontsize', ['fontsize']],
        // é¡è‰²
        ['color', ['color']],
        // æ®µè½
        ['para', ['ul', 'ol', 'paragraph']],
        ['height', ['height']],
        // è¡¨æ ¼
        ['table', ['table']],
        // æ’å…¥
        ['insert', ['link', 'picture', 'video', 'hr']],
        // é¡¯ç¤º
        ['view', ['codeview']]
      ]
    });
  });
</script>

<!-- æ›´æ–°(ç·¨è¼¯)å•†å“è³‡è¨Š and å¸¶å…¥æ¬²ä¿®æ”¹å•†å“åŸæœ‰è³‡è¨Š -->
<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const token = localStorage.getItem('adminToken');
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');

    if (!productId) {
      alert('âŒ ç„¡æ•ˆçš„å•†å“ ID');
      return;
    }

    const ageSelect = document.getElementById('ageRange');
    const themeSelect = document.getElementById('theme');
    const statusSelect = document.getElementById('status');

    // è¼‰å…¥ä¸»é¡Œèˆ‡å¹´é½¡å±¤é¸å–®
    async function loadSelectOptions() {
      const [themeRes, ageRes] = await Promise.all([
        fetch(`${window.API_BASE_URL}/admin/categories`, {
          headers: { Authorization: `Bearer ${token}` }
        }),
        fetch(`${window.API_BASE_URL}/admin/ageRanges`, {
          headers: { Authorization: `Bearer ${token}` }
        })
      ]);

      const themeData = await themeRes.json();
      const ageData = await ageRes.json();

      if (themeData.status) {
        themeData.data.categories.forEach(cat => {
          const opt = document.createElement('option');
          opt.value = cat.id;
          opt.textContent = cat.name;
          themeSelect.appendChild(opt);
        });
      }

      if (ageData.status) {
        ageData.data.ageRanges.forEach(age => {
          const opt = document.createElement('option');
          opt.value = age.id;
          opt.textContent = age.name;
          ageSelect.appendChild(opt);
        });
      }
    }

    // è¼‰å…¥å•†å“è³‡æ–™
    async function loadProductDetail() {
      const res = await fetch(`${window.API_BASE_URL}/admin/products/${productId}`, {
        headers: { Authorization: `Bearer ${token}` }
      });

      const json = await res.json();
      if (!json.status) {
        alert('âŒ è¼‰å…¥å¤±æ•—ï¼š' + json.message);
        return;
      }

      const data = json.data;

      document.getElementById('title').value = data.title || '';
      document.getElementById('author').value = data.author || '';
      document.getElementById('illustrator').value = data.illustrator || '';
      document.getElementById('publisher').value = data.publisher || '';
      document.getElementById('isbn').value = data.isbn || '';
      document.getElementById('description').value = data.description || '';
      document.getElementById('price').value = data.price || '';
      document.getElementById('discountPrice').value = data.discountPrice || '';
      document.getElementById('stock').value = data.stockQuantity || '';
      document.getElementById('pageCount').value = data.pageCount || '';
      document.getElementById('publishDate').value = data.publishDate || '';
      $('#contentIntro').summernote('code', data.introductionHtml || '');

      // âœ… åŠ é€™ä¸€è¡Œï¼Œç”¨ä¾†æ¸²æŸ“åœ–ç‰‡å¡ç‰‡
      renderImageList(data.imageUrls || []);

      // âœ… è¼‰å…¥é¸å–®å¾Œå†é¸æ“‡
      await loadSelectOptions();

      // âœ… ä¿®æ­£å•†å“ç‹€æ…‹      
      statusSelect.value = data.isVisible === true ? 'true' : 'false';


      ageSelect.value = data.ageRangeId?.toString();
      themeSelect.value = data.categoryId?.toString();

      // å•†å“æ¨™ç±¤
      if (data.isNewArrival) document.getElementById('tag-1').checked = true;
      if (data.isBestseller) document.getElementById('tag-2').checked = true;
      if (data.isDiscount) document.getElementById('tag-3').checked = true;
    }

    await loadProductDetail();

    // é€å‡ºæ›´æ–°è¡¨å–®
    document.getElementById('addProductForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const payload = {
        title: document.getElementById('title').value.trim(),
        author: document.getElementById('author').value.trim(),
        illustrator: document.getElementById('illustrator').value.trim(),
        publisher: document.getElementById('publisher').value.trim(),
        isbn: document.getElementById('isbn').value.trim(),
        description: document.getElementById('description').value.trim(),
        introductionHtml: $('#contentIntro').summernote('code'),
        isVisible: statusSelect.value === 'true',
        price: parseInt(document.getElementById('price').value, 10),
        discountPrice: parseInt(document.getElementById('discountPrice').value, 10) || 0,
        stockQuantity: parseInt(document.getElementById('stock').value, 10),
        pageCount: parseInt(document.getElementById('pageCount').value, 10) || 0,
        publishDate: document.getElementById('publishDate').value,
        ageRangeId: parseInt(ageSelect.value, 10),
        categoryId: parseInt(themeSelect.value, 10),
        isNewArrival: document.getElementById('tag-1').checked,
        isBestseller: document.getElementById('tag-2').checked,
        isDiscount: document.getElementById('tag-3').checked
      };


      try {
        const res = await fetch(`${window.API_BASE_URL}/admin/products/${productId}`, {
          method: 'PUT',
          headers: {
            Authorization: `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        const json = await res.json();
        if (json.status) {
          alert('âœ… æ›´æ–°æˆåŠŸ');
          window.location.href = '/products';
        } else {
          alert('âŒ æ›´æ–°å¤±æ•—ï¼š' + json.message);
        }
      } catch (err) {
        console.error('âŒ æ›´æ–°éŒ¯èª¤', err);
        alert('ä¼ºæœå™¨éŒ¯èª¤');
      }
    });
  });

  // âœ… è¼‰å…¥å•†å“åœ–ç‰‡åˆ°ã€Œå•†å“åœ–ç‰‡ã€tab
  function renderImageList(imageData) {
    const imageList = document.getElementById('imageList');
    imageList.innerHTML = ''; // æ¸…ç©ºç¾æœ‰å…§å®¹

    const totalSlots = 6;
    const paddedData = [];

    for (let i = 0; i < totalSlots; i++) {
      paddedData.push(imageData[i] || {
        imageUrl: '',
        isPrimary: i === 0 && !imageData.some(img => img.isPrimary)
      });
    }

    paddedData.forEach((img, index) => {
      const card = document.createElement('div');
      card.className = 'card mb-3 image-item';
      card.dataset.index = index;

      const isMainChecked = img.isPrimary ? 'checked' : '';
      const previewImage = img.imageUrl
        ? `<div class="mt-2"><img src="${img.imageUrl}" alt="åœ–ç‰‡é è¦½" class="img-thumbnail" style="max-height: 180px;"></div>`
        : '';

      card.innerHTML = `
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>åœ–ç‰‡ ${index + 1}</strong>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label">ä¸Šå‚³åœ–ç‰‡</label>
          <input type="file" name="productImages" class="form-control">
        </div>
        <div class="form-check mt-2">
          <input class="form-check-input" type="radio" name="mainImage" value="${index}" id="mainImage-${index}" ${isMainChecked}>
          <label class="form-check-label" for="mainImage-${index}">
            è¨­ç‚ºä¸»è¦åœ–ç‰‡
          </label>
        </div>
        ${previewImage}
      </div>
    `;

      imageList.appendChild(card);
    });
  }
</script>


<!-- ä¸²æ¥åœ–ç‰‡ä¸Šå‚³ API -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const token = localStorage.getItem('adminToken');
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');

    if (!productId) {
      console.warn("âŒ ç¼ºå°‘ productIdï¼Œç„¡æ³•ä¸Šå‚³åœ–ç‰‡");
      return;
    }

    const imageForm = document.getElementById('uploadImagesForm');

    imageForm?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const inputs = [...document.querySelectorAll('input[name="productImages"]')];
      const selectedRadio = document.querySelector('input[name="mainImage"]:checked');

      const formData = new FormData();
      const validFiles = [];

      // æ”¶é›†æœ‰æª”æ¡ˆçš„æ¬„ä½
      inputs.forEach((input, i) => {
        if (input.files.length > 0) {
          formData.append("productImages", input.files[0]);
          validFiles.push({ index: i });
        }
      });

      // è¨ˆç®—ä¸»è¦åœ–ç‰‡çš„å¯¦éš› index
      const mainFormIndex = selectedRadio ? parseInt(selectedRadio.value, 10) : 0;
      const realMainIndex = validFiles.findIndex(file => file.index === mainFormIndex);

      // è‹¥ä¸»åœ–é¸çš„æ˜¯æ²’æœ‰æª”æ¡ˆçš„æ¬„ä½ï¼Œå‰‡æç¤ºéŒ¯èª¤
      if (realMainIndex === -1) {
        alert("âŒ è«‹å°‡ã€è¨­ç‚ºä¸»åœ–ã€å‹¾é¸åœ¨æœ‰é¸æ“‡æª”æ¡ˆçš„æ¬„ä½ä¸Šï¼");
        return;
      }

      formData.set("isPrimary", realMainIndex);


      try {
        const res = await fetch(`${window.API_BASE_URL}/admin/products/${productId}/images`, {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${token}`
          },
          body: formData
        });

        const json = await res.json();
        if (json.status) {
          alert('âœ… åœ–ç‰‡ä¸Šå‚³æˆåŠŸ');
          window.location.href = '/products?page=9999';
          // location.reload();
        } else {
          alert('âŒ ä¸Šå‚³å¤±æ•—ï¼š' + json.message);
        }
      } catch (err) {
        console.error('âŒ ä¸Šå‚³éŒ¯èª¤', err);
        alert('ä¼ºæœå™¨éŒ¯èª¤');
      }
    });
  });
</script>