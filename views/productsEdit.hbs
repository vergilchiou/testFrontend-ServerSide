<div class="modal-dialog modal-xl">
  <div class="modal-content">
    <!-- 標題列 -->
    <div class="modal-header">
      <h5 class="modal-title">編輯商品</h5>
      <a href="/products" class="btn-close"></a>
    </div>

    <!-- 主體 -->
    <div class="modal-body">
      <!-- 分頁標籤 -->
      <ul class="nav nav-tabs" id="productTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" type="button"
            role="tab">基本資料</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="images-tab" data-bs-toggle="tab" data-bs-target="#images" type="button"
            role="tab">商品圖片</button>
        </li>
      </ul>

      <div class="tab-content pt-3" id="productTabContent">
        <!-- 基本資料 分頁 -->
        <div class="tab-pane fade show active" id="basic" role="tabpanel" aria-labelledby="basic-tab">
          <form id="addProductForm" data-product-id="{{productId}}">

            <div class="row g-3">
              <div class="col-md-6">
                <label for="title" class="form-label">書籍標題 *</label>
                <input type="text" class="form-control" id="title" name="title" required>
              </div>
              <div class="col-md-6">
                <label for="author" class="form-label">作者</label>
                <input type="text" class="form-control" id="author" name="author">
              </div>
              <div class="col-md-6">
                <label for="illustrator" class="form-label">繪者</label>
                <input type="text" class="form-control" id="illustrator" name="illustrator">
              </div>
              <div class="col-md-6">
                <label for="publisher" class="form-label">出版社</label>
                <input type="text" class="form-control" id="publisher" name="publisher">
              </div>
              <div class="col-md-6">
                <label for="isbn" class="form-label">ISBN號碼</label>
                <input type="text" class="form-control" id="isbn" name="isbn">
              </div>
              <div class="col-12">
                <label for="description" class="form-label">商品描述</label>
                <textarea class="form-control" id="description" name="description" rows="3"></textarea>
              </div>
              <div class="col-md-6">
                <label for="status" class="form-label">商品狀態</label>
                <select class="form-select" id="status" name="status" required>
                  <option value="true">已上架</option>
                  <option value="false">已下架</option>
                </select>
              </div>
              <!-- Summernote -->
              <div class="col-12">
                <label for="contentIntro" class="form-label">書籍內容介紹</label>
                <textarea id="contentIntro" name="contentIntro"></textarea>
              </div>
              <hr class="my-4">
              <div class="col-md-4">
                <label for="price" class="form-label">售價 *</label>
                <input type="number" step="0.01" class="form-control" id="price" name="price" required>
              </div>
              <div class="col-md-4">
                <label for="discountPrice" class="form-label">折扣後價格</label>
                <input type="number" step="0.01" class="form-control" id="discountPrice" name="discountPrice">
              </div>
              <div class="col-md-4">
                <label for="stock" class="form-label">庫存數量 *</label>
                <input type="number" class="form-control" id="stock" name="stock" required>
              </div>
              <div class="col-md-3">
                <label for="pageCount" class="form-label">頁數</label>
                <input type="number" class="form-control" id="pageCount" name="pageCount">
              </div>
              <div class="col-md-3">
                <label for="publishDate" class="form-label">出版日期</label>
                <input type="date" class="form-control" id="publishDate" name="publishDate">
              </div>
              <div class="col-md-3">
                <label for="ageRange" class="form-label">年齡層分類 *</label>
                <select class="form-select" id="ageRange" name="ageRange" required>
                  <option value="">請選擇年齡層</option>
                </select>

              </div>
              <div class="col-md-3">
                <label for="theme" class="form-label">商品主題 *</label>
                <select class="form-select" id="theme" name="theme" required>
                  <option value="">請選擇主題</option>
                </select>
              </div>
              <div class="col-12">
                <label class="form-label">商品標籤</label>
                <div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="tag-1" name="isNewArrival">
                    <label class="form-check-label me-3" for="tag-1">新品上市</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="tag-2" name="isBestseller">
                    <label class="form-check-label me-3" for="tag-2">熱銷品項</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="tag-3" name="isDiscount">
                    <label class="form-check-label me-3" for="tag-3">特價中</label>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>

        <!-- 商品圖片 分頁 -->
        <div class="tab-pane fade" id="images" role="tabpanel" aria-labelledby="images-tab">
          <form id="uploadImagesForm" enctype="multipart/form-data">
            <div id="imageList">
              {{#each [0,1,2,3,4,5]}}
              <div class="card mb-3 image-item" data-index="{{this}}">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <strong>圖片 {{addOne this}}</strong>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <label class="form-label">上傳圖片</label>
                    <input type="file" name="productImages" class="form-control">
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="mainImage" value="{{this}}"
                      id="mainImage-{{this}}" {{#if @first}}checked{{/if}}>
                    <label class="form-check-label" for="mainImage-{{this}}">
                      設為主要圖片
                    </label>
                  </div>
                </div>
              </div>
              {{/each}}
            </div>
            <button type="submit" class="btn btn-success w-100">📤 上傳圖片</button>
          </form>
        </div>



      </div>
    </div>

    <!-- 按鈕列 -->
    <div class="modal-footer my-2">
      <a type="button" href="/products" class="btn btn-secondary">取消</a>
      <button type="submit" form="addProductForm" class="btn btn-primary ms-2">確定新增</button>
    </div>
  </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>

<!-- summernote -->
<script>
  $(document).ready(function () {
    $('#contentIntro').summernote({
      height: 300,
      toolbar: [
        // 樣式
        ['style', ['style']],
        // 文字
        ['font', ['bold', 'italic', 'underline', 'strikethrough', 'clear']],
        // 字型
        ['fontname', ['fontname']],
        ['fontsize', ['fontsize']],
        // 顏色
        ['color', ['color']],
        // 段落
        ['para', ['ul', 'ol', 'paragraph']],
        ['height', ['height']],
        // 表格
        ['table', ['table']],
        // 插入
        ['insert', ['link', 'picture', 'video', 'hr']],
        // 顯示
        ['view', ['codeview']]
      ]
    });
  });
</script>

<!-- 更新(編輯)商品資訊 and 帶入欲修改商品原有資訊 -->
<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const token = localStorage.getItem('adminToken');
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');

    if (!productId) {
      alert('❌ 無效的商品 ID');
      return;
    }

    const ageSelect = document.getElementById('ageRange');
    const themeSelect = document.getElementById('theme');
    const statusSelect = document.getElementById('status');

    // 載入主題與年齡層選單
    async function loadSelectOptions() {
      const [themeRes, ageRes] = await Promise.all([
        fetch(`${window.API_BASE_URL}/admin/categories`, {
          headers: { Authorization: `Bearer ${token}` }
        }),
        fetch(`${window.API_BASE_URL}/admin/ageRanges`, {
          headers: { Authorization: `Bearer ${token}` }
        })
      ]);

      const themeData = await themeRes.json();
      const ageData = await ageRes.json();

      if (themeData.status) {
        themeData.data.categories.forEach(cat => {
          const opt = document.createElement('option');
          opt.value = cat.id;
          opt.textContent = cat.name;
          themeSelect.appendChild(opt);
        });
      }

      if (ageData.status) {
        ageData.data.ageRanges.forEach(age => {
          const opt = document.createElement('option');
          opt.value = age.id;
          opt.textContent = age.name;
          ageSelect.appendChild(opt);
        });
      }
    }

    // 載入商品資料
    async function loadProductDetail() {
      const res = await fetch(`${window.API_BASE_URL}/admin/products/${productId}`, {
        headers: { Authorization: `Bearer ${token}` }
      });

      const json = await res.json();
      if (!json.status) {
        alert('❌ 載入失敗：' + json.message);
        return;
      }

      const data = json.data;

      document.getElementById('title').value = data.title || '';
      document.getElementById('author').value = data.author || '';
      document.getElementById('illustrator').value = data.illustrator || '';
      document.getElementById('publisher').value = data.publisher || '';
      document.getElementById('isbn').value = data.isbn || '';
      document.getElementById('description').value = data.description || '';
      document.getElementById('price').value = data.price || '';
      document.getElementById('discountPrice').value = data.discountPrice || '';
      document.getElementById('stock').value = data.stockQuantity || '';
      document.getElementById('pageCount').value = data.pageCount || '';
      document.getElementById('publishDate').value = data.publishDate || '';
      $('#contentIntro').summernote('code', data.introductionHtml || '');

      // ✅ 加這一行，用來渲染圖片卡片
      renderImageList(data.imageUrls || []);

      // ✅ 載入選單後再選擇
      await loadSelectOptions();

      // ✅ 修正商品狀態      
      statusSelect.value = data.isVisible === true ? 'true' : 'false';


      ageSelect.value = data.ageRangeId?.toString();
      themeSelect.value = data.categoryId?.toString();

      // 商品標籤
      if (data.isNewArrival) document.getElementById('tag-1').checked = true;
      if (data.isBestseller) document.getElementById('tag-2').checked = true;
      if (data.isDiscount) document.getElementById('tag-3').checked = true;
    }

    await loadProductDetail();

    // 送出更新表單
    document.getElementById('addProductForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const payload = {
        title: document.getElementById('title').value.trim(),
        author: document.getElementById('author').value.trim(),
        illustrator: document.getElementById('illustrator').value.trim(),
        publisher: document.getElementById('publisher').value.trim(),
        isbn: document.getElementById('isbn').value.trim(),
        description: document.getElementById('description').value.trim(),
        introductionHtml: $('#contentIntro').summernote('code'),
        isVisible: statusSelect.value === 'true',
        price: parseInt(document.getElementById('price').value, 10),
        discountPrice: parseInt(document.getElementById('discountPrice').value, 10) || 0,
        stockQuantity: parseInt(document.getElementById('stock').value, 10),
        pageCount: parseInt(document.getElementById('pageCount').value, 10) || 0,
        publishDate: document.getElementById('publishDate').value,
        ageRangeId: parseInt(ageSelect.value, 10),
        categoryId: parseInt(themeSelect.value, 10),
        isNewArrival: document.getElementById('tag-1').checked,
        isBestseller: document.getElementById('tag-2').checked,
        isDiscount: document.getElementById('tag-3').checked
      };


      try {
        const res = await fetch(`${window.API_BASE_URL}/admin/products/${productId}`, {
          method: 'PUT',
          headers: {
            Authorization: `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        const json = await res.json();
        if (json.status) {
          alert('✅ 更新成功');
          window.location.href = '/products';
        } else {
          alert('❌ 更新失敗：' + json.message);
        }
      } catch (err) {
        console.error('❌ 更新錯誤', err);
        alert('伺服器錯誤');
      }
    });
  });

  // ✅ 載入商品圖片到「商品圖片」tab
  function renderImageList(imageData) {
    const imageList = document.getElementById('imageList');
    imageList.innerHTML = ''; // 清空現有內容

    const totalSlots = 6;
    const paddedData = [];

    for (let i = 0; i < totalSlots; i++) {
      paddedData.push(imageData[i] || {
        imageUrl: '',
        isPrimary: i === 0 && !imageData.some(img => img.isPrimary)
      });
    }

    paddedData.forEach((img, index) => {
      const card = document.createElement('div');
      card.className = 'card mb-3 image-item';
      card.dataset.index = index;

      const isMainChecked = img.isPrimary ? 'checked' : '';
      const previewImage = img.imageUrl
        ? `<div class="mt-2"><img src="${img.imageUrl}" alt="圖片預覽" class="img-thumbnail" style="max-height: 180px;"></div>`
        : '';

      card.innerHTML = `
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>圖片 ${index + 1}</strong>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label">上傳圖片</label>
          <input type="file" name="productImages" class="form-control">
        </div>
        <div class="form-check mt-2">
          <input class="form-check-input" type="radio" name="mainImage" value="${index}" id="mainImage-${index}" ${isMainChecked}>
          <label class="form-check-label" for="mainImage-${index}">
            設為主要圖片
          </label>
        </div>
        ${previewImage}
      </div>
    `;

      imageList.appendChild(card);
    });
  }
</script>


<!-- 串接圖片上傳 API -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const token = localStorage.getItem('adminToken');
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');

    if (!productId) {
      console.warn("❌ 缺少 productId，無法上傳圖片");
      return;
    }

    const imageForm = document.getElementById('uploadImagesForm');

    imageForm?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const inputs = [...document.querySelectorAll('input[name="productImages"]')];
      const selectedRadio = document.querySelector('input[name="mainImage"]:checked');

      const formData = new FormData();
      const validFiles = [];

      // 收集有檔案的欄位
      inputs.forEach((input, i) => {
        if (input.files.length > 0) {
          formData.append("productImages", input.files[0]);
          validFiles.push({ index: i });
        }
      });

      // 計算主要圖片的實際 index
      const mainFormIndex = selectedRadio ? parseInt(selectedRadio.value, 10) : 0;
      const realMainIndex = validFiles.findIndex(file => file.index === mainFormIndex);

      // 若主圖選的是沒有檔案的欄位，則提示錯誤
      if (realMainIndex === -1) {
        alert("❌ 請將『設為主圖』勾選在有選擇檔案的欄位上！");
        return;
      }

      formData.set("isPrimary", realMainIndex);


      try {
        const res = await fetch(`${window.API_BASE_URL}/admin/products/${productId}/images`, {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${token}`
          },
          body: formData
        });

        const json = await res.json();
        if (json.status) {
          alert('✅ 圖片上傳成功');
          window.location.href = '/products?page=9999';
          // location.reload();
        } else {
          alert('❌ 上傳失敗：' + json.message);
        }
      } catch (err) {
        console.error('❌ 上傳錯誤', err);
        alert('伺服器錯誤');
      }
    });
  });
</script>