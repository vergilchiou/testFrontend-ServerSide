<div class="modal-dialog modal-xl">
  <div class="modal-content">
    <!-- 標題列 -->
    <div class="modal-header">
      <h5 class="modal-title">新增商品</h5>
      <a href="/products" class="btn-close"></a>
    </div>

    <!-- 主體 -->
    <div class="modal-body">
      <!-- 分頁標籤 -->
      <ul class="nav nav-tabs" id="productTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" type="button"
            role="tab">基本資料</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="images-tab" data-bs-toggle="tab" data-bs-target="#images" type="button"
            role="tab" disabled>商品圖片</button>
        </li>
      </ul>

      <div class="tab-content pt-3" id="productTabContent">
        <!-- 基本資料 分頁 -->
        <div class="tab-pane fade show active" id="basic" role="tabpanel" aria-labelledby="basic-tab">
          <form id="addProductForm" data-product-id="{{productId}}">

            <div class="row g-3">
              <div class="col-md-6">
                <label for="title" class="form-label">書籍標題 *</label>
                <input type="text" class="form-control" id="title" name="title" required>
              </div>
              <div class="col-md-6">
                <label for="author" class="form-label">作者</label>
                <input type="text" class="form-control" id="author" name="author">
              </div>
              <div class="col-md-6">
                <label for="illustrator" class="form-label">繪者</label>
                <input type="text" class="form-control" id="illustrator" name="illustrator">
              </div>
              <div class="col-md-6">
                <label for="publisher" class="form-label">出版社</label>
                <input type="text" class="form-control" id="publisher" name="publisher">
              </div>
              <div class="col-md-6">
                <label for="isbn" class="form-label">ISBN號碼</label>
                <input type="text" class="form-control" id="isbn" name="isbn">
              </div>
              <div class="col-12">
                <label for="description" class="form-label">商品描述</label>
                <textarea class="form-control" id="description" name="description" rows="3"></textarea>
              </div>
              <div class="col-md-6">
                <label for="status" class="form-label">商品狀態</label>
                <select class="form-select" id="status" name="status" required>
                  <option value="true">已上架</option>
                  <option value="false">已下架</option>
                </select>
              </div>
              <!-- Summernote -->
              <div class="col-12">
                <label for="contentIntro" class="form-label">書籍內容介紹</label>
                <textarea id="contentIntro" name="contentIntro"></textarea>
              </div>
              <hr class="my-4">
              <div class="col-md-4">
                <label for="price" class="form-label">售價 *</label>
                <input type="number" step="0.01" class="form-control" id="price" name="price" required>
              </div>
              <div class="col-md-4">
                <label for="discountPrice" class="form-label">折扣後價格</label>
                <input type="number" step="0.01" class="form-control" id="discountPrice" name="discountPrice">
              </div>
              <div class="col-md-4">
                <label for="stock" class="form-label">庫存數量 *</label>
                <input type="number" class="form-control" id="stock" name="stock" required>
              </div>
              <div class="col-md-3">
                <label for="pageCount" class="form-label">頁數</label>
                <input type="number" class="form-control" id="pageCount" name="pageCount">
              </div>
              <div class="col-md-3">
                <label for="publishDate" class="form-label">出版日期</label>
                <input type="date" class="form-control" id="publishDate" name="publishDate">
              </div>
              <div class="col-md-3">
                <label for="ageRange" class="form-label">年齡層分類 *</label>
                <select class="form-select" id="ageRange" name="ageRange" required>
                  <option value="">請選擇年齡層</option>
                </select>

              </div>
              <div class="col-md-3">
                <label for="theme" class="form-label">商品主題 *</label>
                <select class="form-select" id="theme" name="theme" required>
                  <option value="">請選擇主題</option>
                </select>
              </div>
              <div class="col-12">
                <label class="form-label">商品標籤</label>
                <div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="tag-1" name="isNewArrival">
                    <label class="form-check-label me-3" for="tag-1">新品上市</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="tag-2" name="isBestseller">
                    <label class="form-check-label me-3" for="tag-2">熱銷品項</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="tag-3" name="isDiscount">
                    <label class="form-check-label me-3" for="tag-3">特價中</label>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- 按鈕列 -->
    <div class="modal-footer my-2">
      <a type="button" href="/products" class="btn btn-secondary">取消</a>
      <button type="submit" form="addProductForm" class="btn btn-primary ms-2">確定新增</button>
    </div>
  </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>

<!-- summernote -->
<script>
  $(document).ready(function () {
    $('#contentIntro').summernote({
      height: 300,
      toolbar: [
        // 樣式
        ['style', ['style']],
        // 文字
        ['font', ['bold', 'italic', 'underline', 'strikethrough', 'clear']],
        // 字型
        ['fontname', ['fontname']],
        ['fontsize', ['fontsize']],
        // 顏色
        ['color', ['color']],
        // 段落
        ['para', ['ul', 'ol', 'paragraph']],
        ['height', ['height']],
        // 表格
        ['table', ['table']],
        // 插入
        ['insert', ['link', 'picture', 'video', 'hr']],
        // 顯示
        ['view', ['codeview']]
      ]
    });
  });
</script>

<!-- 更新(編輯)商品資訊 and 帶入欲修改商品原有資訊 -->
<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const token = localStorage.getItem('adminToken');
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');


    const ageSelect = document.getElementById('ageRange');
    const themeSelect = document.getElementById('theme');
    const statusSelect = document.getElementById('status');

    // 載入主題與年齡層選單
    async function loadSelectOptions() {
      const [themeRes, ageRes] = await Promise.all([
        fetch(`${window.API_BASE_URL}/admin/categories`, {
          headers: { Authorization: `Bearer ${token}` }
        }),
        fetch(`${window.API_BASE_URL}/admin/ageRanges`, {
          headers: { Authorization: `Bearer ${token}` }
        })
      ]);

      const themeData = await themeRes.json();
      const ageData = await ageRes.json();

      if (themeData.status) {
        themeData.data.categories.forEach(cat => {
          const opt = document.createElement('option');
          opt.value = cat.id;
          opt.textContent = cat.name;
          themeSelect.appendChild(opt);
        });
      }

      if (ageData.status) {
        ageData.data.ageRanges.forEach(age => {
          const opt = document.createElement('option');
          opt.value = age.id;
          opt.textContent = age.name;
          ageSelect.appendChild(opt);
        });
      }
    }

    // 載入商品資料
    await loadSelectOptions();

    // 測試工具
    // 自動填入資料
    // 基本欄位
    document.getElementById('title').value = '測試用書名';
    document.getElementById('author').value = '測試作者';
    document.getElementById('illustrator').value = '測試插畫家';
    document.getElementById('publisher').value = '測試出版社';
    document.getElementById('isbn').value = '9781234567897';
    document.getElementById('description').value = '這是測試用的書籍描述';

    // Summernote - 書籍介紹（使用 HTML）
    $('#contentIntro').summernote('code', '<p>這是測試的書籍介紹 HTML</p>');

    // 數值欄位
    document.getElementById('price').value = '300';
    document.getElementById('discountPrice').value = '250';
    document.getElementById('stock').value = '50';
    document.getElementById('pageCount').value = '32';

    // 日期
    document.getElementById('publishDate').value = '2025-06-22';

    // 下拉選單（年齡層、分類）
    ageSelect.value = '1';   // 替換成實際存在的 ageRangeId
    themeSelect.value = '1'; // 替換成實際存在的 categoryId

    // 狀態與標籤
    statusSelect.value = 'true';
    document.getElementById('tag-1').checked = true;
    document.getElementById('tag-2').checked = false;
    document.getElementById('tag-3').checked = false;

    // 送出更新表單
    document.getElementById('addProductForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const payload = {
        title: document.getElementById('title').value.trim(),
        author: document.getElementById('author').value.trim(),
        illustrator: document.getElementById('illustrator').value.trim(),
        publisher: document.getElementById('publisher').value.trim(),
        isbn: document.getElementById('isbn').value.trim(),
        description: document.getElementById('description').value.trim(),
        introductionHtml: $('#contentIntro').summernote('code'),
        isVisible: statusSelect.value === 'true',
        price: parseInt(document.getElementById('price').value, 10),
        discountPrice: parseInt(document.getElementById('discountPrice').value, 10) || 0,
        stockQuantity: parseInt(document.getElementById('stock').value, 10),
        pageCount: parseInt(document.getElementById('pageCount').value, 10) || 0,
        publishDate: document.getElementById('publishDate').value,
        ageRangeId: parseInt(ageSelect.value, 10),
        categoryId: parseInt(themeSelect.value, 10),
        isNewArrival: document.getElementById('tag-1').checked,
        isBestseller: document.getElementById('tag-2').checked,
        isDiscount: document.getElementById('tag-3').checked
      };
      console.log(payload.introductionHtml)
      console.log(payload.introductionHtml.length)

      try {
        const res = await fetch(`${window.API_BASE_URL}/admin/products`, {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        const json = await res.json();

        if (json.status) {
          const newProductId = json.data?.id;
          const total = json.data?.total;
          const limit = 5;
          const totalPages = total ? Math.ceil(total / limit) : null;

          if (newProductId) {
            alert('✅ 商品新增成功');
            window.location.href = `/productsEdit?id=${newProductId}&tab=image`;
          } else {
            alert('⚠️ 商品建立成功，但未收到商品 ID，請手動回到商品列表');
            window.location.href = totalPages
              ? `/products?page=${totalPages}`
              : '/products';
          }
        } else {
          alert('❌ 更新失敗：' + json.message);
        }
      } catch (err) {
        console.error('❌ 更新錯誤', err);
        alert('伺服器錯誤');
      }
    });
  });

</script>