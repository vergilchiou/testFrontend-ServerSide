<!-- orderEdit.hbs -->
<div class="container mt-4">
  <div class="card shadow">
    <div class="card-header bg-light d-flex justify-content-between">
      <h5 class="mb-0">ç·¨è¼¯è¨‚å–®</h5>
      <a href="/orders" class="btn-close"></a>
    </div>

    <div class="modal-body p-2">
      <ul class="nav nav-tabs mb-3" id="orderEditTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabOrderInfo" type="button"
            role="tab">è¨‚å–®è³‡è¨Š</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabRecipientInfo" type="button"
            role="tab">æ”¶ä»¶è³‡è¨Š</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabOrderDetails" type="button"
            role="tab">è¨‚å–®æ˜ç´°</button>
        </li>
      </ul>

      <div class="tab-content">
        <!-- è¨‚å–®è³‡è¨Š -->
        <div class="tab-pane fade show active" id="tabOrderInfo" role="tabpanel">
          <form id="orderInfoForm">
            <div class="row mb-3">
              <div class="col-md-4">
                <label class="form-label">è¨‚å–®ç·¨è™Ÿ</label>
                <input type="text" class="form-control" id="orderNumber" disabled>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">è¨‚å–®ç‹€æ…‹</label>
                <select class="form-select" id="orderStatus" disabled></select>
              </div>
              <div class="col-md-4">
                <label class="form-label">é‹é€ç‹€æ…‹</label>
                <select class="form-select" id="shippingStatus" disabled></select>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-4">
                <label class="form-label">ä»˜æ¬¾æ–¹å¼</label>
                <input type="text" class="form-control" id="paymentMethod" disabled>
              </div>
              <div class="col-md-4">
                <label class="form-label">ä»˜æ¬¾ç‹€æ…‹</label>
                <select class="form-select" id="paymentStatus" disabled></select>
              </div>
              <div class="col-md-4">
                <label class="form-label">äº¤æ˜“ç·¨è™Ÿ</label>
                <input type="text" class="form-control" id="transactionNumber" disabled>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-3">
                <label class="form-label">è¨‚å–®ç¸½é‡‘é¡</label>
                <input type="number" class="form-control" id="totalAmount">
              </div>
              <div class="col-md-3">
                <label class="form-label">é‹è²»</label>
                <input type="number" class="form-control" id="shippingFee">
              </div>
              <div class="col-md-3">
                <label class="form-label">æŠ˜æ‰£é‡‘é¡</label>
                <input type="number" class="form-control" id="discountAmount">
              </div>
              <div class="col-md-3">
                <label class="form-label">æœ€çµ‚é‡‘é¡</label>
                <input type="number" class="form-control" id="finalAmount">
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">è¨‚å–®å‚™è¨»</label>
              <textarea class="form-control" id="note" rows="2"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">ç‹€æ…‹å‚™è¨»</label>
              <textarea class="form-control" id="statusNote" rows="2"></textarea>
            </div>
          </form>
        </div>

        <!-- æ”¶ä»¶è³‡è¨Š -->
        <div class="tab-pane fade" id="tabRecipientInfo" role="tabpanel">
          <form id="recipientForm">
            <div class="mb-3">
              <label class="form-label">æ”¶ä»¶äººå§“å</label>
              <input type="text" class="form-control" id="recipientName">
            </div>
            <div class="mb-3">
              <label class="form-label">æ”¶ä»¶äººé›»è©±</label>
              <input type="text" class="form-control" id="recipientPhone">
            </div>
            <div class="mb-3">
              <label class="form-label">é‹é€æ–¹å¼</label>
              <input type="text" class="form-control" id="shippingMethod" disabled>
            </div>
            <div class="mb-3">
              <label class="form-label">é‹é€åœ°å€</label>
              <textarea class="form-control" id="shippingAddress" rows="2"></textarea>
            </div>
          </form>
        </div>

        <!-- è¨‚å–®æ˜ç´° -->
        <div class="tab-pane fade" id="tabOrderDetails" role="tabpanel">
          <table class="table">
            <thead>
              <tr>
                <th>å•†å“åç¨±</th>
                <th>æ•¸é‡</th>
                <th>å–®åƒ¹</th>
                <th>å°è¨ˆ</th>
              </tr>
            </thead>
            <tbody id="orderItemsTable"></tbody>
            <tfoot>
              <tr>
                <td colspan="3" class="text-end">å•†å“å°è¨ˆï¼š</td>
                <td id="orderItemTotal"></td>
              </tr>
              <tr>
                <td colspan="3" class="text-end">é‹è²»ï¼š</td>
                <td id="orderShippingFee"></td>
              </tr>
              <tr>
                <td colspan="3" class="text-end">æŠ˜æ‰£é‡‘é¡ï¼š</td>
                <td id="orderDiscountAmount"></td>
              </tr>
              <tr>
                <td colspan="3" class="text-end fw-bold">è¨‚å–®ç¸½è¨ˆï¼š</td>
                <td id="orderSummaryTotal" class="fw-bold"></td>
              </tr>
            </tfoot>
          </table>
          <div class="ms-2">

            <p>ç”¨æˆ¶åç¨±ï¼š<span class="fw-bold" id="userName"></span></p>
            <p>Emailï¼š<span class="fw-bold" id="userEmail"></span></p>
            <p>é›»è©±ï¼š<span class="fw-bold" id="userPhone"></span></p>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer mb-2">
      <a type="button" href="/orders" class="btn btn-secondary">å–æ¶ˆ</a>
      <button type="button" class="btn btn-primary ms-2" id="saveOrderChanges">ä¿å­˜æ›´æ”¹</button>
    </div>
  </div>
</div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", async () => {
    const token = localStorage.getItem("adminToken");
    const urlParams = new URLSearchParams(window.location.search);
    const orderNumber = urlParams.get("orderNumber");

    // å¯é¸ç‹€æ…‹é¸é …ï¼ˆæ ¹æ“šä½ çš„è³‡æ–™åº«é‚è¼¯ï¼‰
    const orderStatusOptions = ["å¾…å‡ºè²¨", "å·²å‡ºè²¨", "å·²å®Œæˆ", "å·²å–æ¶ˆ", "å·²ç”³è«‹é€€è²¨", "å·²ç”³è«‹é€€è²¨", "å·²åŒæ„é€€è²¨", "å·²æ‹’çµ•é€€è²¨"];
    const paymentStatusOptions = ["å·²ä»˜æ¬¾", "å·²é€€æ¬¾", "å·²å–æ¶ˆæˆæ¬Š"];
    const shippingStatusOptions = ["å°šæœªæ”¶è²¨", "è™•ç†ä¸­", "é‹é€ä¸­", "å·²åˆ°è²¨", "å·²é€€è²¨"];

    // å°‡ä¸‹æ‹‰é¸å–®é¸é …æ¸²æŸ“åˆ° DOM
    function populateSelect(selectId, optionsArray, selectedValue) {
      const select = document.getElementById(selectId);
      select.innerHTML = "";
      optionsArray.forEach(opt => {
        const option = document.createElement("option");
        option.value = opt;
        option.textContent = opt;
        if (opt === selectedValue) option.selected = true;
        select.appendChild(option);
      });
    }

    if (!orderNumber || !token) {
      alert("ç„¡æ•ˆçš„è¨‚å–®ç·¨è™Ÿæˆ–æœªç™»å…¥");
      return;
    }

    const res = await fetch(`${window.API_BASE_URL}/admin/orders/${orderNumber}`, {
      headers: {
        Authorization: `Bearer ${token}`,
      },
    });
    const result = await res.json();
    if (!result.status) {
      alert("ç„¡æ³•è¼‰å…¥è¨‚å–®è³‡æ–™ï¼š" + result.message);
      return;
    }

    const data = result.data;

    populateSelect("orderStatus", orderStatusOptions, data.orderStatus);
    populateSelect("paymentStatus", paymentStatusOptions, data.paymentStatus);
    populateSelect("shippingStatus", shippingStatusOptions, data.shippingStatus);

    document.getElementById("orderNumber").value = data.orderNumber;
    document.getElementById("paymentMethod").value = data.paymentMethod || "â€”";
    document.getElementById("transactionNumber").value = data.transactionNumber || "â€”";
    document.getElementById("totalAmount").value = data.totalAmount;
    document.getElementById("shippingFee").value = data.shippingFee;
    document.getElementById("discountAmount").value = data.discountAmount;
    document.getElementById("finalAmount").value = data.finalAmount;
    document.getElementById("note").value = data.note || "";
    document.getElementById("statusNote").value = data.statusNote || "";

    document.getElementById("recipientName").value = data.shippingInfo.recipientName;
    document.getElementById("recipientPhone").value = data.shippingInfo.recipientPhone;
    document.getElementById("shippingAddress").value = data.shippingInfo.shippingAddress;
    document.getElementById("shippingMethod").value = data.shippingInfo.shippingMethod || "â€”";
    // document.getElementById("storeName").value = data.shippingInfo.storeName || "â€”";
    // document.getElementById("storeCode").value = data.shippingInfo.storeCode || "â€”";
    // document.getElementById("trackingNumber").value = data.shippingInfo.trackingNumber || "â€”";    

    const tbody = document.getElementById("orderItemsTable");
    // 
    if (!tbody) {
      console.error("â— éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° id ç‚º orderItemsTable çš„ <tbody>");
      return;
    }


    tbody.innerHTML = "";
    let itemTotal = 0;
    data.items.forEach(item => {
      // console.log("ğŸ…¸ Item:", item);
      itemTotal += item.subtotal;
      const tr = document.createElement("tr");
      tr.innerHTML = `
    <td class="text-start">${item.productTitle}</td>
    <td>${item.quantity}</td>
    <td>$${item.price}</td>
    <td>$${item.subtotal}</td>
  `;
      tbody.appendChild(tr);
    });

    const shippingFee = data.shippingFee || 0;
    const discountAmount = data.discountAmount || 0;
    const grandTotal = itemTotal + shippingFee - discountAmount;

    // æ¸²æŸ“å°è¨ˆã€é‹è²»èˆ‡ç¸½è¨ˆ
    document.getElementById("orderItemTotal").textContent = `$${itemTotal}`;
    document.getElementById("orderShippingFee").textContent = `$${shippingFee}`;
    document.getElementById("orderDiscountAmount").textContent = `$${discountAmount}`;
    document.getElementById("orderSummaryTotal").textContent = `$${grandTotal}`;


    // ===== é¡¯ç¤ºç”¨æˆ¶è³‡è¨Š =====
    document.getElementById("userName").innerText = data.user.name;
    document.getElementById("userEmail").innerText = data.user.email;
    document.getElementById("userPhone").innerText = data.user.phone;
  });
</script>